<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Week Data to Final Table</title>
  <!-- Include SheetJS from a CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Upload Your data (57).xlsx</h2>
  <input type="file" id="inputFile" accept=".xlsx, .xls">
  <button onclick="processFile()">Process File</button>

  <script>
    /**************************************************
     * 1) Parse a "Truck / Trailer" string
     **************************************************/
    function parseTruckTrailer(str) {
      // Remove bracketed prefix like [BW/P], [BW/G], etc.
      str = str.replace(/\[BW\/[A-Z]\]/gi, "").trim();

      // Detect driver count (default = 2, but if "1v" is found => 1)
      let drivers = 2;
      if (/1v/i.test(str)) drivers = 1;

      // Split on the first slash to separate truck vs. trailer
      let [left, right = ""] = str.split("/", 2);
      left = left.trim();
      right = right.trim();

      // Use a regex to find the first alphanumeric chunk in each side
      const truckMatch = left.match(/[A-Z0-9]+/i);
      const trailerMatch = right.match(/[A-Z0-9]+/i);

      const truck = truckMatch ? truckMatch[0] : left;
      const trailer = trailerMatch ? trailerMatch[0] : right;

      return { truck, trailer, drivers };
    }

    /**************************************************
     * 2) Convert comma decimals to floats, or null if empty
     **************************************************/
    function parseCommaFloat(val) {
      // If cell is empty or whitespace, return null
      if (!val || val.toString().trim() === "") return null;

      // Convert comma to decimal point and parse
      const num = parseFloat(val.toString().replace(",", "."));
      // If invalid, return null
      return isNaN(num) ? null : num;
    }

    /**************************************************
     * 3) Merge rows for the same truck
     **************************************************/
    function mergeByTruck(rows) {
      const byTruck = {};

      for (let r of rows) {
        const truck = r.Truck;
        if (!byTruck[truck]) {
          // First time we see this truck
          byTruck[truck] = r;
        } else {
          const existing = byTruck[truck];

          // "Has W7" = not null
          const newHasW7 = r["Week 7"] != null;
          const oldHasW7 = existing["Week 7"] != null;

          // CASE A: new row has W7, old doesn't => new row is main
          if (newHasW7 && !oldHasW7) {
            // If new row's W6 is null, move old row's W6
            if (r["Week 6"] == null && existing["Week 6"] != null) {
              r["Week 6"] = existing["Week 6"];
            }
            byTruck[truck] = r; // new row replaces old
          }
          // CASE B: old row has W7, new doesn't => keep old, but move new's W6 if old W6 is null
          else if (oldHasW7 && !newHasW7) {
            if (existing["Week 6"] == null && r["Week 6"] != null) {
              existing["Week 6"] = r["Week 6"];
            }
          }
          // CASE C: both have W7 => keep new row, but move old's W6 if new's is null
          else if (oldHasW7 && newHasW7) {
            if (r["Week 6"] == null && existing["Week 6"] != null) {
              r["Week 6"] = existing["Week 6"];
            }
            byTruck[truck] = r;
          }
          // CASE D: neither has W7 => keep old, but move new's W6 if old's is null
          else {
            if (existing["Week 6"] == null && r["Week 6"] != null) {
              existing["Week 6"] = r["Week 6"];
            }
          }
        }
      }

      return Object.values(byTruck);
    }

    /**************************************************
     * 4) Transform the sheet data into our final rows
     **************************************************/
    function transformData(dataAoA) {
      const rows = [];

      // Start from row index 2 to skip your first two header lines
      for (let i = 2; i < dataAoA.length; i++) {
        const row = dataAoA[i];
        if (!row || !row.length) break;

        // If the first cell is "Total" or empty, stop
        if (!row[0] || /^total$/i.test(row[0].toString().trim())) {
          break;
        }

        const rawTruckTrailer = row[0].toString().trim();
        const week6Val = parseCommaFloat(row[1]);
        const week7Val = parseCommaFloat(row[2]);

        const { truck, trailer, drivers } = parseTruckTrailer(rawTruckTrailer);

        rows.push({
          Truck: truck,
          Trailer: trailer,
          "Week 6": week6Val,
          "Week 7": week7Val,
          Drivers: drivers
        });
      }

      // Merge duplicates by truck
      const merged = mergeByTruck(rows);

      // Calculate totals & averages (skip null cells)
      let sum6 = 0, sum7 = 0;
      let count6 = 0, count7 = 0;

      merged.forEach(r => {
        if (r["Week 6"] != null) {
          sum6 += r["Week 6"];
          count6++;
        }
        if (r["Week 7"] != null) {
          sum7 += r["Week 7"];
          count7++;
        }
      });

      // If there's no data in a column, we'll show empty for average & total
      const avg6 = count6 > 0 ? Math.round(sum6 / count6) : "";
      const avg7 = count7 > 0 ? Math.round(sum7 / count7) : "";
      const total6 = count6 > 0 ? Math.round(sum6) : "";
      const total7 = count7 > 0 ? Math.round(sum7) : "";

      // Add "Total Average" row
      merged.push({
        Truck: "",
        Trailer: "Total Average:",
        "Week 6": avg6,
        "Week 7": avg7,
        Drivers: ""
      });

      // Add "Total Amount" row
      merged.push({
        Truck: "",
        Trailer: "Total Amount:",
        "Week 6": total6,
        "Week 7": total7,
        Drivers: ""
      });

      return merged;
    }

    /**************************************************
     * 5) Create a styled worksheet from final data
     **************************************************/
    function createStyledSheet(data) {
      // Convert data to an array-of-arrays, starting with headers
      const aoa = [
        ["Truck", "Trailer", "Week 6", "Week 7", "Drivers"]
      ];

      data.forEach(row => {
        aoa.push([
          row.Truck,
          row.Trailer,
          row["Week 6"] == null ? "" : row["Week 6"],
          row["Week 7"] == null ? "" : row["Week 7"],
          row.Drivers == null ? "" : row.Drivers
        ]);
      });

      // Create worksheet from AoA
      const ws = XLSX.utils.aoa_to_sheet(aoa);

      // Set column widths
      ws['!cols'] = [
        { wch: 10 }, // Truck
        { wch: 12 }, // Trailer
        { wch: 10 }, // Week 6
        { wch: 10 }, // Week 7
        { wch: 8 }   // Drivers
      ];

      // Simple styling for header row (bold + gray fill + centered)
      const headerCells = ["A1", "B1", "C1", "D1", "E1"];
      headerCells.forEach(cellAddr => {
        if (ws[cellAddr]) {
          ws[cellAddr].s = {
            font: { bold: true },
            fill: { fgColor: { rgb: "D9D9D9" } },
            alignment: { horizontal: "center" }
          };
        }
      });

      // Bold the last two rows (Total Average / Total Amount)
      const totalAvgRowIndex = aoa.length - 2; // second-last
      const totalAmtRowIndex = aoa.length - 1; // last
      [totalAvgRowIndex, totalAmtRowIndex].forEach(rowIndex => {
        for (let col = 0; col < 5; col++) {
          const addr = XLSX.utils.encode_cell({ r: rowIndex, c: col });
          if (!ws[addr]) continue;
          ws[addr].s = ws[addr].s || {};
          ws[addr].s.font = ws[addr].s.font || {};
          ws[addr].s.font.bold = true;
        }
      });

      // If you want borders, uncomment this block:
      /*
      for (let R = 0; R < aoa.length; R++) {
        for (let C = 0; C < aoa[0].length; C++) {
          const addr = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[addr]) continue;
          ws[addr].s = ws[addr].s || {};
          ws[addr].s.border = {
            top:    { style: "thin", color: { rgb: "000000" } },
            bottom: { style: "thin", color: { rgb: "000000" } },
            left:   { style: "thin", color: { rgb: "000000" } },
            right:  { style: "thin", color: { rgb: "000000" } }
          };
        }
      }
      */

      return ws;
    }

    /**************************************************
     * 6) Main function to process the file
     **************************************************/
    function processFile() {
      const fileInput = document.getElementById('inputFile');
      if (!fileInput.files.length) {
        alert("Please select an Excel file.");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const dataArray = new Uint8Array(e.target.result);
        // Read workbook as an array-of-arrays
        const workbook = XLSX.read(dataArray, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // Convert the sheet to array-of-arrays
        const dataAoA = XLSX.utils.sheet_to_json(worksheet, {
          header: 1,
          defval: ""
        });

        // Transform data into final format
        const finalData = transformData(dataAoA);

        // Create a new styled worksheet
        const newWorksheet = createStyledSheet(finalData);

        // Build a new workbook and append the styled sheet
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "Cleaned Data");

        // Download the result
        XLSX.writeFile(newWorkbook, "cleaned_data.xlsx");
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
